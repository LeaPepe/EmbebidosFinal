<!DOCTYPE HTML><html>

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://code.highcharts.com/highcharts.js"></script>
  <script src="https://code.highcharts.com/themes/dark-unica.js"></script>
  <style>
    body {
		min-width: 310px;
		max-width: 800px;
		height: 400px;
		margin: 0 auto;
    }
    h2 {
      font-family: Arial;
      font-size: 2.5rem;
      text-align: center;
    }
  </style>
</head>

<body style="background-color:#2a2a2b;">
  <h2>Phasor</h2>
  <div id="chart-lineparams" class="container"></div>
  <div id="chart-powers" class="container"></div>
  <div id="chart-samples" class="container"></div>
</body>

<script>
//Chart Vrms, Irms, CosPhi
var chartLP = new Highcharts.Chart({
	chart:{ renderTo:'chart-lineparams'},
	title:{
		text: 'Line Parameters' ,
		align: 'left'},
	subtitle: {
		text: 'Vrms, Irms, CosPhi',
		align: 'left'},
	xAxis:[{
		title:{ text: 'Time [H:M:S]' },
		type: 'datetime',
		dateTimeLabelFormats: { second: '%H:%M:%S' }}],
	yAxis: [{ // Primary yAxis
        labels: {
            format: '{value} A',
            style: {
                color: '#8dd3c7'
            }
        },
        title: {
            text: 'Current',
            style: {
                color: '#8dd3c7'
            }
        }
    }, { // Secondary yAxis
        gridLineWidth: 0,
		title: {
            text: 'Voltage',
            style: {
                color: '#bebada'
            }
        },
        labels: {
            format: '{value} V',
            style: {
                color: '#bebada'
            }
        }
    }, { // Terciary yAxis
        gridLineWidth: 0,
		title: {
            text: 'Cos phi',
            style: {
                color: '#ffffb3'
            }
        },
        labels: {
            format: '{value} °',
            style: {
                color: '#ffffb3'
            }
        },
        opposite: true
    }],
	credits: { enabled: false },
	series: [{ // first
		name: 'Vrms',
		yAxis: 1,
		data: [],
		color: '#bebada',
		tooltip: { valueSuffix: ' V'}},
	{ // Second
		name: 'Irms',
		yAxis: 2,
		data: [],
		color: '#8dd3c7',
		tooltip: { valueSuffix: ' A'}},
	{ // Third
		name: 'Cos phi',
		data: [],
		color: '#ffffb3',
		tooltip: { valueSuffix: ' °'},
		dashStyle: 'shortdot'}],
	tooltip: {
        shared: true
    }}
);

//ChartPowers
var chartPows = new Highcharts.Chart({
	chart:{
		renderTo:'chart-powers'},
	title:{
		text: 'Power triangle' ,
		align: 'left'},
	subtitle: {
		text: 'Active Power, Reactive Power, Aparent Power',
		align: 'left'},
	plotOptions:{
		line:{
			animation: false,
			dataLabels: { enabled: true }}},
	xAxis:{
		title:{ text: 'Time [H:M:S]' },
		type: 'datetime',
		dateTimeLabelFormats: { second: '%H:%M:%S' }},
	yAxis: [{ // Primary yAxis
		labels: {
			format: '{value} A',
			style: {
				color: '#2b908f'}},
		title: {
			text: 'Current',
			style: {
				color: '#2b908f'}},
		opposite: true},
	{ // Secondary yAxis
		gridLineWidth: 0,
		title: {
			text: 'Reactive',
			style: {
				color: '#90ee7e'}},
		labels:{
			format: '{value} VAR',
			style: {
				color: '#90ee7e'}}},
	{ // Tertiary yAxis
		gridLineWidth: 0,
		title: {
			text: 'Aparent',
			style: {
				color: '#7798BF'}},
		labels: {
			format: '{value} VA',
			style: {
				color: '#2b908f'}},
			opposite: true}],
	credits: { enabled: false },
	series: [{ // first
		name: 'Active Power',
		type: 'spline',
		yAxis: 1,
		data: [],
		color: '#2b908f',
		tooltip: { valueSuffix: ' W'}},
	{ // Second
		name: 'Rective Power',
		type: 'spline',
		yAxis: 2,
		data: [],
		color: '#90ee7e',
		marker: {enabled: false},
		tooltip: {valueSuffix: ' VAR'}},
	{ // Third
		name: 'Aparent Power',
		type: 'spline',
		data: [],
		color: '#7798BF',
		tooltip: { valueSuffix: ' VA'}}],}
);

//ChartSamples
var chartS = new Highcharts.Chart({
	chart:{
		renderTo:'chart-samples'},
	title:{
		text: 'Raw data' ,
		align: 'left'},
	subtitle: {
		text: 'Instant voltage and current',
		align: 'left'},
	plotOptions:{
		line:{
			animation: false,
			dataLabels: { enabled: true }}},
	xAxis:{
		title:{ text: 'Time [ms]' }},
	yAxis: [{ // Primary yAxis
		labels: {
			format: '{value} V',
			style: {
				color: '#2b908f'}},
		title: {
			text: 'Current',
			style: {
				color: '#2b908f'}},
		opposite: true},
	{ // Tertiary yAxis
		gridLineWidth: 0,
		title: {
			text: 'Current',
			style: {
				color: '#7798BF'}},
		labels: {
			format: '{value} A',
			style: {
				color: '#2b908f'}},
			opposite: true}],
	credits: { enabled: false },
	series: [{ // first
		name: 'Voltage',
		type: 'spline',
		yAxis: 1,
		data: [],
		color: '#2b908f',
		tooltip: { valueSuffix: ' V'}},
	{ // Third
		name: 'Current',
		type: 'spline',
		data: [],
		color: '#7798BF',
		tooltip: { valueSuffix: ' A'}}],}
);


// request every second
setInterval(function ( ) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
      var t = (new Date()).getTime();
	  var obj = JSON.parse(this.responseText);
	  // ToDo:parsear los datos
	  var sinphi = Math.sqrt(1.0 - (obj.cosphi* obj.cosphi));
	  if (obj.cosphi < 0) sinphi * (-1);
	  
      if(chartLP.series[0].data.length > 40) {
        chartLP.series[0].addPoint([t, obj.vrms], true, true, true);
		chartLP.series[1].addPoint([t, obj.irms], true, true, true);
		chartLP.series[2].addPoint([t, obj.cosphi], true, true, true);
		
		chartPows.series[0].addPoint([t, obj.vrms*obj.irms*obj.cosphi], true, true, true);
		chartPows.series[1].addPoint([t,  obj.vrms*obj.irms*obj.sinphi], true, true, true);
		chartPows.series[2].addPoint([t, obj.vrms*obj.irms], true, true, true);
      } else {
        chartLP.series[0].addPoint([t, obj.vrms], true, false, true);
		chartLP.series[1].addPoint([t, obj.irms], true, false, true);
		chartLP.series[2].addPoint([t, obj.cosphi], true, false, true);
		chartPows.series[0].addPoint([t, obj.vrms*obj.irms*obj.cosphi], true, false, true);
		chartPows.series[1].addPoint([t,  obj.vrms*obj.irms*obj.sinphi], true, false, true);
		chartPows.series[2].addPoint([t, obj.vrms*obj.irms], true, false, true);
      }
    }
  };
  xhttp.open("GET", "/params", true);
  xhttp.send();
}, 1000 ) ;

// request every ten seconds
setInterval(function ( ) {
  var xhttp = new XMLHttpRequest();
  xhttp.onreadystatechange = function() {
    if (this.readyState == 4 && this.status == 200) {
	  var obj = JSON.parse(this.responseText);
	  // ToDo:parsear los datos
	  var t = obj.t
	  var v = obj.v
	  var i = obj.i
	  
	  for(let j = 0; i < 40;i++)
	  {
	    if(chartLP.series[0].data.length > 40) {
			chartLP.series[0].addPoint([t[j], v[j]], true, true, true);
			chartLP.series[1].addPoint([t[j], i[j]], true, true, true);
		} else {
			chartLP.series[0].addPoint([t[j], v[j]], true, false, true);
			chartLP.series[1].addPoint([t[j], i[j]], true, false, true);
		}
	  }

    }
  };
  xhttp.open("GET", "/samples", true);
  xhttp.send();
}, 10000 ) ;

</script>
</html>
